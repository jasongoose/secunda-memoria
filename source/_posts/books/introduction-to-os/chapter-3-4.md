---
title: 3-4. 스레드
date: 2024-11-29 21:39:28
categories:
  - Books
  - 쉽게 배우는 운영체제
#tags:
---
## 스레드의 개념

### 스레드의 정의

- 프로세스의 코드에 정의된 절차에 따라 CPU가 실행하는 작업 단위입니다.
- 운영체제 입장에서 작업의 단위는 프로세스이고, CPU 입장에서 작업의 단위는 스레드입니다.
- 일반적으로 작업은 상대적인 크기 순으로 job(처리) > task(프로세스) > operation(스레드) > ?(단계)로 구분됩니다.
  - 여러 개의 프로세스를 모아서 한꺼번에 처리하는 방법을 일괄 작업(batch job)이라고 합니다.

### 프로세스와 스레드의 차이

#### 프로세스

- 프로세스들은 서로 약하게 연결되어 있어서 독립적으로 동작할 수 있습니다.

#### 스레드

- 프로세스를 구성하는 스레드들은 서로 강하게 연결되어 있어서 동작에 영향을 줄 수 있습니다.

#### 멀티태스크

- 특정 프로세스가 비정상적으로 종료되어도 다른 프로세스는 정상적으로 동작합니다.
  - PCB가 분리되어 있어서인가?
- 프로세스 간의 통신은 IPC(Inter Process Communication)로 이루어집니다.

#### 멀티스레드

- 프로세스가 종료되면 내부 스레드들도 강제로 종료됩니다.
- 스레드들은 변수나 파일 등의 리소스를 공유하고 전역 변수나 함수 호출 등의 방법으로 스레드 간의 통신이 이루어집니다.

### 스레드 관련 용어

![병렬 처리](/images/thread_related_terms.png)

#### 멀티스레드

- 운영체제가 **소프트웨어적으로** 프로세스를 스레드 단위로 분할하여 운영하는 기법입니다.

#### 멀티태스킹(시분할 시스템)

- 운영체제가 시간을 잘게 나눠서 CPU에 작업(프로세스, 스레드)을 배분하는 기법입니다.

#### 멀티프로세싱

- 여러 개의 CPU 코어를 사용하여 여러 개의 스레드를 동시에 처리하는 기법으로, 슈퍼스칼라 방식을 따릅니다.
- 네트워크로 연결된 여러 컴퓨터에 스레드를 나누어 협업하는 분산 시스템도 여기에 해당합니다.

#### CPU 멀티스레드

- 단일 CPU 코어에서 파이프라인 기법을 이용하여 **하드웨어적으로** 동시에 여러 스레드를 처리하는 병렬 기법입니다.

### 멀티스레드의 구조와 예

#### 스레드의 배경

- 과거에는 운영체제에서 작업을 처리하는 단위가 프로세스 하나만 있었기 때문에, 프로세스가 수행하는 작업들을 동시에 처리하기 위해 fork 시스템 호출로 동일한 프로세스를 복사하거나, exec 시스템 호출로 다른 프로세스를 전환하는 방법을 사용했습니다.
- 하지만 프로세스의 코드 영역과 데이터 영역의 일부가 메모리에 중복되어 존재하고 부모/자식 프로세스가 독립적으로 동작하기 때문에 메모리 낭비 요소를 줄일 수 없습니다.
- 그래서 프로세스의 코드, 데이터 등을 공유하면서 여러 작업들을 단일 프로세스 내에서 처리하기 위해 더 작은 단위인 스레드라는 개념이 생겼습니다.

#### 멀티스레드의 구조

![멀티태스킹과 멀티스레드](/images/multitasking_multithread.png)

- 프로세스는 실행되는 동안 변하지 않는 정적 영역과 변하는 동적 영역(레지스터 중간값, 스택, 힙 등)으로 나뉩니다.
- 멀티태스킹은 fork 시스템 호출에 의해서 정적 영역이 중복되어 메모리가 낭비되는 반면, 멀티스레드는 정적 영역을 공유하여 낭비를 막고 효율성을 향상합니다.
  - 개별 스레드는 독립적인 동적 영역을 가집니다.
- 이러한 성질로 스레드는 LWP(Light Weight Process), 단일 스레드를 가진 일반 프로세스는 HWP(Heavy Weight Process)라고도 불립니다.

### 멀티스레드의 장단점

#### 멀티스레드의 장점

- 응답성 향상
  - 한 스레드가 대기 상태에 있어도 다른 스레드는 작업을 계속하여 사용자의 작업 요구에 빠르게 반응할 수 있습니다.
- 정적 자원 공유
  - 프로세스가 가진 자원을 모든 스레드가 공유하여 작업을 원할하게 처리할 수 있습니다. 
- 효율성 향상
  - 불필요한 자원의 중복을 막아서 시스템의 효율성을 높일 수 있습니다(=비용을 줄일 수 있다).
- 다중 CPU 지원
  - 다중 CPU 환경에서 CPU 사용량이 증가하고 프로세스의 처리 시간을 단축됩니다.

#### 멀티스레드의 단점

- 모든 스레드가 자원을 공유하기 때문에 한 스레드에 문제가 생기면 전체 프로세스에 영향을 미칩니다.

### 멀티스레드 모델

- 커널 스레드
  - 커널이 직접 생성하고 관리하는 스레드
- 사용자 스레드
  - 라이브러리에 의해 구현된 일반적인 스레드
  - 사용자 스레드가 커널 스레드를 사용하려면 시스템 호출을 사용해야 합니다.

#### 사용자 레벨 스레드

![1 to N 모델](/images/1_to_n_model.png)

- 운영체제가 멀티스레드를 지원하지 않는 즉, 커널 스레드가 1개인 초기 시스템에서 이용된 방법입니다.
- 사용자 프로세스에서 라이브러리로 여러 사용자 스레드들을 생성하여 커널이 지원하는 스케줄링, 동기화 등의 기능을 대신 구현합니다.
- 따라서 사용자 프로세스에서 여러 개의 스레드가 존재하지만 단일 커널 스레드와 연결되는 1 to N 모델을 형성합니다.
- 장점
  - 사용자 레벨 스레드가 구현한 스케줄링은 커널이 수행하는 문맥 교환 없이 필요한 값만 저장했다가 복구시키면 되기 때문에 속도가 빠릅니다.
- 단점
  - 단일 커널 스레드가 입출력 작업을 위해 대기상태에 들어간다면 모든 사용자 레벨 스레드들이 대기 상태가 되어 병목현상이 일어납니다.
  - 다중 CPU 환경을 지원하지 않습니다.
  - 사용자 레벨 스레드는 커널에서 제공하는 보호 기능을 라이브러리로 직접 구현해야 하므로 보안에 취약합니다.

#### 커널 레벨 스레드

![1 to 1 모델](/images/1_to_1_model.png)

- 운영체제가 멀티스레드를 지원하는 방식으로, 하나의 사용자 스레드가 하나의 커널 스레드와 연결되는 1 to 1 모델을 형성합니다.
- 장점
  - 커널 스레드가 독립적으로 스케줄링이 되므로 특정 커널 스레드가 대기 상태에 들어가도 다른 사용자 스레드는 작업을 계속할 수 있습니다.
  - 커널이 제공하는 보호 기능을 포함한 모든 기능을 사용할 수 있으므로 보안에 강합니다.
- 단점
  - 문맥 교환에 의해 상대적으로 스케줄링 속도가 느립니다.

#### 멀티레벨 스레드

![M to N 모델](/images/m_to_n_model.png)

- 사용자 레벨 스레드와 커널 레벨 스레드를 혼합한 방식으로, M to N 모델을 형성합니다.
- 커널 스레드의 개수는 사용자 스레드의 개수보다 같거나 작습니다.
- 장점
  - 특정 커널 스레드가 대기 상태에 들어가도 남는 스레드가 대신 처리할 수 있어서 사용자 레벨 스레드보다 유연합니다.
- 단점
  - 여전히 문맥 교환에 의해 스케줄링 속도가 느립니다.